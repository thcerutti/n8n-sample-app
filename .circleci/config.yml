version: 2.1

# Define orbs (conjuntos reutilizáveis de configuração)
orbs:
  node: circleci/node@5.1.0
  docker: circleci/docker@2.2.0

# Define workflows
workflows:
  version: 2
  build-test-deploy:
    jobs:
      - build-and-push:
          filters:
            branches:
              only:
                - main

# Define jobs
jobs:
  build-and-push:
    executor: docker/docker
    steps:
      - checkout
      - setup_remote_docker:
          docker_layer_caching: true

      - run:
          name: Login no Docker Hub
          command: |
            echo $DOCKERHUB_ACCESS_TOKEN | docker login -u $DOCKERHUB_USERNAME --password-stdin

      - run:
          name: Build Docker Compose Images
          command: |
            docker compose build

      - run:
          name: List Built Images
          command: |
            docker images | grep n8n-sample-app

      - run:
          name: Tag Images for Docker Hub
          command: |
            # O Docker Compose cria imagens com o padrão: <diretório>-<serviço>
            docker tag n8n-sample-app-backend:latest $DOCKERHUB_USERNAME/$CIRCLE_PROJECT_REPONAME:backend-latest
            docker tag n8n-sample-app-frontend:latest $DOCKERHUB_USERNAME/$CIRCLE_PROJECT_REPONAME:frontend-latest
            docker tag n8n-sample-app-backend:latest $DOCKERHUB_USERNAME/$CIRCLE_PROJECT_REPONAME:backend-$CIRCLE_SHA1
            docker tag n8n-sample-app-frontend:latest $DOCKERHUB_USERNAME/$CIRCLE_PROJECT_REPONAME:frontend-$CIRCLE_SHA1

      - run:
          name: Push All Images (creates repo automatically if not exists)
          command: |
            # O Docker Hub cria repositórios automaticamente no primeiro push
            docker push $DOCKERHUB_USERNAME/$CIRCLE_PROJECT_REPONAME:backend-latest
            docker push $DOCKERHUB_USERNAME/$CIRCLE_PROJECT_REPONAME:frontend-latest
            docker push $DOCKERHUB_USERNAME/$CIRCLE_PROJECT_REPONAME:backend-$CIRCLE_SHA1
            docker push $DOCKERHUB_USERNAME/$CIRCLE_PROJECT_REPONAME:frontend-$CIRCLE_SHA1
